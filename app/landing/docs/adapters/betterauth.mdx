---
title: 'Better Auth Adapter'
description: 'Billing plugin for Better Auth: customers, subscriptions, refunds, credits'
---

The Better Auth adapter adds a **billing plugin** to [Better Auth](https://www.better-auth.com): it links users to Stellar customers and exposes session-protected endpoints for customers, subscriptions, refunds, and credits.

## Install

```bash
pnpm add @stellartools/betterauth-adapter
```

## Database schema

Add the plugin’s user field so Better Auth can store the Stellar customer ID:

```ts
import { betterAuth } from "better-auth";
import { createBilling } from "@stellartools/betterauth-adapter";

export const auth = betterAuth({
  database: { ... },
  plugins: [
    createBilling({
      apiKey: process.env.STELLAR_TOOLS_API_KEY!,
      createCustomerOnSignUp: true, // optional: create Stellar customer on sign up
      creditLowThreshold: 10,
      onCustomerCreated: async (customer) => { /* optional */ },
      onCreditsLow: async (data) => { /* optional */ },
      onSubscriptionCreated: async (data) => { /* optional */ },
    }),
  ],
});
```

The plugin schema adds:

- `user.stellarCustomerId` (string, optional, unique)

Run migrations so your `user` table has a `stellarCustomerId` column.

## Plugin options

| Option | Type | Description |
|--------|------|-------------|
| `apiKey` | `string` | Stellar Tools API key (required). |
| `createCustomerOnSignUp` | `boolean` | Create a Stellar customer when a user signs up (default: `false`). |
| `creditLowThreshold` | `number` | Trigger `onCreditsLow` when balance is at or below this (default: `10`). |
| `onCustomerCreated` | `(customer: Customer) => Promise<void>` | Called when a Stellar customer is created/linked. |
| `onCreditsLow` | `(data: CreditBalance) => Promise<void>` | Called when credits are low after a consume. |
| `onSubscriptionCreated` | `(data: Subscription) => Promise<void>` | Called when a subscription is created. |

## Endpoints

All endpoints require a **session** (Better Auth session middleware). The plugin creates or retrieves a Stellar customer per user and stores `stellarCustomerId` on the user.

### Customers

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/stellar/customer/create` | Create or link Stellar customer; returns customer. |
| `GET` | `/stellar/customer/retrieve` | Get current user’s Stellar customer. |
| `POST` | `/stellar/customer/update` | Update customer (`email`, `name`, `phone`, `metadata`). |

### Subscriptions

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/stellar/subscription/create` | Create subscription (body: `productId`, `period`, `cancelAtPeriodEnd`, optional `metadata`). |
| `GET` | `/stellar/subscription/list` | List subscriptions for the current user’s customer. |

### Credits

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/stellar/credits/consume` | Consume credits (body: `productId`, `rawAmount`, optional `metadata`). Triggers `onCreditsLow` if balance ≤ threshold. |
| `GET` | `/stellar/credits/transactions` | Get credit transactions (query: `productId`, optional `limit`, `offset`). |

### Refunds

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/stellar/refund/create` | Create refund (body: `paymentId`, `amount`, `reason`, `receiverPublicKey`, optional `metadata`). |

## Example: Create subscription

```ts
const res = await fetch("/api/auth/stellar/subscription/create", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  credentials: "include",
  body: JSON.stringify({
    productId: "prod_xxx",
    period: { from: "2025-01-01T00:00:00.000Z", to: "2025-02-01T00:00:00.000Z" },
    cancelAtPeriodEnd: false,
  }),
});
const data = await res.json();
```

Use the session cookie so Better Auth identifies the user and links the subscription to their Stellar customer.
